angular.module("talon",["ionic","talon.constants","talon.controllers","talon.templates","talon.auth","talon.beneficiary","talon.common","talon.nfc","talon.transaction"]).run(["$ionicPlatform","$rootScope","$timeout","$localStorage",function(e,n,t,o){o.currentUser&&(n.currentUser=o.currentUser,n.organization=o.currentUser.Organization,n.country=o.country),e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleLightContent(),window.screen&&window.screen.lockOrientation&&screen.lockOrientation("portrait"),window.nfc&&(window.nfc.addNdefListener(function(e){t(function(){n.$broadcast("nfc:foundTag",e.tag)})}),window.nfc.addNdefFormatableListener(function(e,n){var t=[window.ndef.record(window.ndef.TNF_EXTERNAL_TYPE,util.stringToBytes("application/talon"),util.stringToBytes(forge.util.bytesToHex(forge.random.getBytes(16))),util.stringToBytes(""))];window.nfc.write(t)}))})}]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(e,n,t){t.interceptors.push("authInterceptor"),e.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"AppController"}).state("app.pos",{url:"/pos",views:{menuContent:{templateUrl:"templates/pos.html"}}}).state("app.beneficiary",{url:"/beneficiary",views:{menuContent:{templateUrl:"templates/list-beneficiaries.html"}}}).state("app.view-beneficiary",{url:"/view-beneficiary/:id",views:{menuContent:{templateUrl:"templates/view-beneficiary.html"}}}).state("app.receipts",{url:"/receipts",views:{menuContent:{templateUrl:"templates/blank.html"}}}).state("app.invoices",{url:"/invoices",views:{menuContent:{templateUrl:"templates/blank.html"}}}).state("app.sync",{url:"/sync",views:{menuContent:{templateUrl:"templates/sync.html"}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html"}}}),n.otherwise("/app/pos")}]),angular.module("talon.constants",[]).constant("talonRoot","https://talon.rescue.org/"),angular.module("talon.controllers",["ngStorage","talon.templates","talon.auth","talon.beneficiary","talon.common","talon.nfc","talon.transaction","ngCordova"]).controller("AppController",["$scope","beneficiaryData","$timeout","$rootScope","$cordovaGeolocation","$ionicPlatform","$nfcTools","$localStorage","$ionicModal","$q","$cordovaSpinnerDialog","adminAuthentication","$nfcTools","$settings","$interval",function(e,n,t,o,r,a,i,c,u,l,d,s,i,f,p){function h(){}function v(){return e.pin.deferred=l.defer(),e.pin.passcode="",e.login.modal&&e.pin.modal.show(),e.pin.deferred.promise}function g(n,t){return e.confirmation.deferred=l.defer(),e.confirmation.data=n,e.confirmation.pin=t,e.confirmation.modal&&e.confirmation.modal.show(),e.confirmation.deferred.promise}function m(n,t){return e.qrConfirmation.deferred=l.defer(),e.qrConfirmation.vouchers=[n],e.qrConfirmation.pin=t,e.qrConfirmation.modal&&e.qrConfirmation.modal.show(),e.qrConfirmation.deferred.promise}function y(){return e.signature.deferred=l.defer(),window.screen&&screen.lockOrientation&&screen.lockOrientation("landscape"),e.signature.modal&&(e.signature.modal.show(),e.signature.isOpen=!0),e.signature.deferred.promise}function w(){return e.login.deferred=l.defer(),delete c.authorizationData,delete o.authorizationData,delete c.currentUser,delete o.currentUser,delete c.organization,delete o.organization,delete c.country,delete o.country,e.login.modal&&e.login.modal.show(),e.login.deferred.promise}e.pin=e.$new(),e.login=e.$new(),e.confirmation=e.$new(),e.qrConfirmation=e.$new(),e.signature=e.$new(),o.device={},u.fromTemplateUrl("templates/login.html",{scope:e.login,focusFirstInput:!0,backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(n){e.login.modal=n}),u.fromTemplateUrl("templates/confirmation.html",{scope:e.confirmation,backdropClickToClose:!1}).then(function(n){e.confirmation.modal=n}),u.fromTemplateUrl("templates/qr-confirmation.html",{scope:e.qrConfirmation,backdropClickToClose:!1}).then(function(n){e.qrConfirmation.modal=n}),u.fromTemplateUrl("templates/pin-code.html",{scope:e.pin}).then(function(n){e.pin.modal=n}),u.fromTemplateUrl("templates/signature-pad.html",{scope:e.signature}).then(function(n){e.signature.modal=n,e.signature.isOpen=!1}),c.authorizationData?(o.authorizationData=c.authorizationData,2!=c.authorizationData.tokenType||o.currentUser||s.loadUserData()):e.login.$watch("modal",function(){e.login.modal&&w().then(function(){})}),a.ready(h),o.$on("onResumeCordova",h),a.on("resume",function(){o.currentUser=c.currentUser,o.organization=c.currentUser.Organization,o.country=c.country}),a.ready(function(){var e={timeout:1e4,enableHighAccuracy:!1};r.getCurrentPosition(e).then(function(e){o.currentLocation=e.coords},function(e){})}),e.showPinModal=v,e.showLoginModal=w,e.showConfirmationModal=g,e.showSignaturePad=y,e.showQRConfirmationModal=m,p(function(){f.sync()},12e4)}]),angular.module("talon.auth",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.auth").controller("LoginController",["$scope","$rootScope","$localStorage","vendorAuthentication","adminAuthentication",function(e,n,t,o,r){e.loginData={},e.wrongPassword=!1,e.loginAdmin=function(){r.login(e.loginData.username,e.loginData.password).then(function(){n.authorizationData=t.authorizationData,r.loadUserData().then(function(){e.deferred.resolve(),e.modal.hide(),e.wrongPassword=!1,e.loginData={}})})["catch"](function(){e.wrongPassword=!0})},e.loginVendor=function(){o.login(e.loginData.username,e.loginData.password).then(function(){e.deferred.resolve(),e.modal.hide(),e.wrongPassword=!1,e.loginData={},n.authorizationData=t.authorizationData})["catch"](function(){e.wrongPassword=!0})}}]),angular.module("talon.auth").factory("authInterceptor",["$q","$injector","$location","$localStorage",function(e,n,t,o,r){var a={},i=function(e){e.headers=e.headers||{};var n=o.authorizationData;if(n&&(e.headers.Authorization=(1==o.authorizationData.tokenType?"Token ":"Bearer ")+n.token),o.currentUser){if(o.authorizationData&&2==o.authorizationData.tokenType&&o.currentUser.Organization){var t=o.currentUser.Organization.Id;e.headers["X-Tenant-Organization"]=t}if(o.authorizationData&&1==o.authorizationData.tokenType){o.currentUser.Id}if(o.country){var r=o.country.Id;e.headers["X-Tenant-Country"]=r}}return e},c=function(n){return 401===n.status,e.reject(n)};return a.request=i,a.responseError=c,a}]),angular.module("talon.auth").service("adminAuthentication",["$http","$localStorage","$q","$rootScope","talonRoot","$cordovaDevice",function(e,n,t,o,r,a){function i(o,r){var a="grant_type=password&username="+o+"&password="+r,i=t.defer();return e.post(l+"token",a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){n.authorizationData={token:e.access_token,userName:o,uuid:d.UUID||d.uuid,tokenType:2},i.resolve(!0)}).error(function(e,n){c(),i.reject(!1)}),i.promise}function c(){}function u(){var r=t.defer();if(n.currentUser){o.currentUser=n.currentUser,o.organization=o.currentUser.Organization;var a=o.currentUser.Countries.map(function(e){return e.Country});n.country||(n.country=a[0]),o.country=n.country,o.availableCountries=o.currentUser.Countries.length>1?a:!1,r.resolve()}else e.get(l+"api/ApplicationUser/Me").then(function(e){o.currentUser=e.data,n.currentUser=e.data,o.organization=o.currentUser.Organization,n.organization=o.currentUser.Organization;var t=o.currentUser.Countries.map(function(e){return e.Country});n.country||(n.country=t[0]),o.country=n.country,o.availableCountries=o.currentUser.Countries.length>1?t:!1,r.resolve()})["catch"](function(e){r.reject(e)});return r.promise}var l=r,d={};return window.device?d=a.getDevice():d.uuid="00:00:00:00",{login:i,logOut:c,loadUserData:u}}]).service("vendorAuthentication",["$http","$q","talonRoot","$cordovaDevice","$localStorage","$rootScope",function(e,n,t,o,r,a){function i(a,i){var u={};window.device?u=o.getDevice():u.uuid="00:00:00:00";var l={UserName:a,Password:i,Device:u},d=n.defer();return e.post(t+"api/App/VendorProfile/Login",l).then(function(e){200==e.status?(r.authorizationData={userName:l.UserName,token:e.data.token,uuid:u.UUID||u.uuid,tokenType:1},c(e.data.id).then(function(){d.resolve(r.authorizationData)})):d.reject(e.data)})["catch"](function(e,n){d.reject(e)}),d.promise}function c(o){var i=n.defer();return r.currentUser?(a.currentUser=r.currentUser,r.country=a.currentUser.Country,a.country=r.country,i.resolve()):e.get(t+"api/App/VendorProfile/LoadProfile").then(function(e){a.currentUser=e.data,r.currentUser=e.data,r.country||(r.country=a.currentUser.Country),a.country=r.country,i.resolve()})["catch"](function(e){i.reject(e)}),i.promise}var u={login:i};return u}]),angular.module("talon.beneficiary",["ngStorage","ngCordova","talon.constants","pouchdb","talon.nfc","talon.common"]),angular.module("talon.beneficiary").controller("BeneficiaryController",["$scope","$localStorage","$ionicModal","$cordovaSpinnerDialog","beneficiaryData",function(e,n,t,o,r){function a(){var n=function(e){o.hide()};e.showPinModal().then(function(e){o.show("Reload Card","Please hold NFC card close to reader",!0),r.reloadCard(e).then(function(){o.hide()})["catch"](n)})["catch"](n)}function i(){var n=function(e){o.hide()};o.show("Read Card","Please hold NFC card close to reader",!0),r.readRawCardData().then(function(t){e.showPinModal().then(function(a){r.readCardData(a,t).then(function(n){e.cardInfo=n,o.hide()})["catch"](n)})["catch"](n)})["catch"](n)}e.reloadCard=a,e.readCard=i}]).controller("ListBeneficiaryController",["$scope","$localStorage","$q","$timeout","$http","beneficiaryData",function(e,n,t,o,r,a){function i(n){return c&&o.cancel(c),c=o(function(){a.listBeneficiariesByName(n).then(function(n){e.beneficiaries=n}),c=null},500)}e.beneficiaries=[],e.beneficiariesByName=i;var c=null}]).controller("ViewBeneficiaryController",["$scope","$localStorage","$q","$timeout","$http","$state","talonRoot","beneficiaryData","$cordovaSpinnerDialog","$ionicModal",function(e,n,t,o,r,a,i,c,u,l){e.voucherBook=e.$new(),c.fetchBeneficiaryById(a.params.id).then(function(n){e.beneficiary=n,e.voucherBook.scan=function(){var n=function(e){};window.cordova&&window.cordova.plugins&&window.cordova.plugins.barcodeScanner&&cordova.plugins.barcodeScanner.scan(function(t){o(function(){var o=t.text;t.cancelled||c.assignVoucherBook(e.beneficiary.Id,e.voucherBook.selectedDistributionId,o).then(function(){e.voucherBook.modal.hide()})["catch"](n)})},n)},e.voucherBook.updateDistribution=function(n){e.voucherBook.selectedDistributionId=n.id},e.voucherBook.cancel=function(){e.voucherBook.modal.hide()},e.setPin=function(){var n=function(e){},t=e.beneficiary.Id;e.showPinModal().then(function(e){u.show("PIN","Updating PIN.",!0),c.setPin(t,e).then(function(){u.hide()})["catch"](n)})["catch"](n)},e.provisionCard=function(){var n=function(e){u.hide()},t=e.beneficiary.Id;u.show("Read Card","Please hold NFC card close to reader",!0),c.provisionBeneficiary(t).then(function(){u.hide()})["catch"](n)},e.assignVoucherBook=function(){l.fromTemplateUrl("templates/assign-voucher-book.html",{scope:e.voucherBook}).then(function(n){e.voucherBook.modal=n,e.voucherBook.modal.show(),c.listDistributions(e.beneficiary.Id).then(function(n){e.voucherBook.distributions=n,e.voucherBook.selectedDistributionId=null})})}})}]),angular.module("talon.beneficiary").directive("ionSearch",function(){return{restrict:"E",replace:!0,scope:{getData:"&source",model:"=?",search:"=?filter"},link:function(e,n,t){t.minLength=t.minLength||0,e.placeholder=t.placeholder||"",e.search={value:""},t["class"]&&n.addClass(t["class"]),t.source&&e.$watch("search.value",function(n,o){n.length>t.minLength?e.getData({str:n}).then(function(n){e.model=n}):e.model=[]}),e.clearSearch=function(){e.search.value=""}},template:'<div class="item-input-wrapper"><i class="icon ion-android-search"></i><input type="search" placeholder="{{placeholder}}" ng-model="search.value"><i ng-if="search.value.length > 0" ng-click="clearSearch()" class="icon ion-close"></i></div>'}}).directive("signaturePad",["$timeout",function(e){return{restrict:"E",scope:{model:"=",cancelled:"=",accepted:"=",isOpen:"="},link:function(e,n,t){e.acceptSignature=function(){e.accepted&&e.accepted($("#signature-pad",n).jSignature("getData","svgbase64"))},e.closeDialog=function(){e.cancelled&&e.cancelled()},e.clearSignature=function(){$("#signature-pad",n).jSignature("reset")};var o=!1;e.$watch("isOpen",function(){e.isOpen&&(o||($("#signature-pad").jSignature(),o=!0),0==$("#signature-pad",n).children().length&&$("#signature-pad",n).jSignature("reset"))})},template:'<div id="signature-pad" style="height:60%; overflow: hidden;"></div><div class="row"><div class="col"><button class="button button-assertive button-block" ng-click="closeDialog()">Cancel</button></div><div class="col"><button class="button button-stable button-block" ng-click="clearSignature()">Clear</button></div><div class="col"></div><div class="col"></div><div class="col"><button class="button button-positive button-block" ng-click="acceptSignature()">Accept</button></div></div>'}}]),angular.module("talon.beneficiary").service("beneficiaryData",["$http","$localStorage","keyDB","cardLoadDB","$q","talonRoot","qrCodeDB","$nfcTools","$ionicPlatform","$timeout","$cordovaFile","$cordovaFileTransfer","httpUtils","encryption","$state",function(e,n,t,o,r,a,i,c,u,l,d,s,f,p,h){function v(e,n){return i.find(function(n){return n.VoucherCode==e}).then(function(e){var o=e;if(0==o.length)throw new Error("Invalid voucher.");var r=o[0];return t.find(function(e){return e.BeneficiaryId==r.BeneficiaryId}).then(function(e){if(0==e.length)throw new Error("Beneficiary not registered");var t=e[0],o=forge.util.decode64(r.Payload),a=p.decrypt(o,n,t.CardKey);if(!a)throw new Error("Invalid pin.");var i=a.split("|"),c=parseFloat(i[1],10),u=parseInt(i[2],16),l=i[3];return{value:c,validAfter:u,voucherCode:l,beneficiary:t}})})}function g(n){var o=r.defer();return c.readId().then(function(r){e.post(a+"api/App/MobileClient/ProvisionBeneficiary",{beneficiaryId:n,cardId:r}).then(function(n){var r=n.data;t.upsert(r._id,r),e.get(a+"api/App/MobileClient/GenerateInitialLoad?beneficiaryId="+r.BeneficiaryId).then(function(e){var n=e.data;n=forge.util.bytesToHex(forge.util.decode64(n)),c.writeData(n,r.CardId).then(o.resolve.bind(o))})})})["catch"](function(){o.reject()}),o.promise}function m(n,t){return e.post(a+"api/App/MobileClient/SetBeneficiaryPin",{beneficiaryId:n,pin:t}).then(function(e){})}function y(n,t,o){return e.post(a+"api/App/MobileClient/AssignVoucherBook",{beneficiaryId:n,distributionId:t,serialNumber:o}).then(function(e){})}function w(n){return e.get(a+"api/App/MobileClient/ListDistributionsForBeneficiary?beneficiaryId="+n).then(function(e){return e.data})}function C(){var e=r.defer(),n=!1,t=l(function(){n||(n=!0,e.reject())},15e3);return c.readIdAndData().then(function(o){n||(l.cancel(t),e.resolve(o),n=!0)}),e.promise}function b(e,n){var t=null;return t=r.when(n?n:C()),t.then(function(n){return T(n.id).then(function(t){return S(n.data,t.CardKey,e).then(function(e){return{beneficiary:t,payload:e}})})})}function D(e){var n=r.defer(),t=function(e){n.reject(e)};return $(e).then(function(o){var r=o.pending,a=o.card.payload,i=o.card.beneficiary,c=a[0];if(0==r[0])return void n.resolve();var u="1933|"+(r[0]+c)+"|"+r[1].unix().toString(16);l(function(){B(u,i.CardKey,e,i.CardId).then(function(e){n.resolve()})["catch"](t)},500)})["catch"](t),n.promise}function $(e,n){var t=r.defer(),a=function(e){t.reject(e)},i=r.defer();return n?i.resolve(n):b(e).then(i.resolve.bind(i)),i.promise.then(function(n){{var r=n.payload,i=n.beneficiary,c=moment.unix(r[1]);r[0]}o.find(function(e){return e.CardId==i.CardId}).then(function(o){0==o.length&&t.resolve({pending:[0,0],card:n});var r=o[0].Load,a=r.map(function(n){var t=forge.util.decode64(n),o=p.decrypt(t,e,i.CardKey);if(!o)throw new Error;var r=o.split("|");return[parseFloat(r[1],10),moment.unix(parseInt(r[2],16))]}),u=a.filter(function(e){return e[1]>c}).reduce(function(e,n){return[e[0]+n[0],e[1]>n[1]?e[1]:n[1]]},[0,0]);t.resolve(0==u[0]&&0==u[1]?{pending:[0,0],card:n}:{pending:u,card:n})})["catch"](a)})["catch"](a),t.promise}function B(e,n,t,o){var a=p.encrypt(e,t,n),i=forge.util.createBuffer(forge.util.decode64(a),"raw").toHex(),u=r.defer();return c.writeData(i,o).then(function(e){u.resolve(e)}),u.promise}function S(e,n,t){var o=r.defer(),a=e.indexOf("0000");a%2==1&&(a+=1);var i=a>-1?e.substring(0,a):e,c=forge.util.hexToBytes(i),u=p.decrypt(c,t,n);if(!u)return o.reject(),o.promise;var l=u.split("|"),d=[parseFloat(l[1],10),parseInt(l[2],16)];return o.resolve(d),o.promise}function T(e){var n=r.defer();return t.find(function(n){return n.CardId==e}).then(function(e){e.length&&n.resolve(e[0]),n.reject()}),n.promise}function U(n){var t="$filter=startswith(tolower(FirstName), '"+encodeURIComponent(n.toLowerCase())+"') or startswith(tolower(LastName), '"+encodeURIComponent(n.toLowerCase())+"')";return e.get(a+"Breeze/EVM/Beneficiaries?"+t).then(function(e){return e.data})}function I(n){return e.get(a+"Breeze/EVM/Beneficiaries?$expand=Location&$filter=Id eq "+h.params.id).then(function(e){return e.data[0]})}return{reloadCard:D,readCardData:b,readRawCardData:C,updateCardData:B,provisionBeneficiary:g,listBeneficiariesByName:U,fetchBeneficiaryById:I,fetchPendingLoads:$,validateQRCode:v,setPin:m,listDistributions:w,assignVoucherBook:y}}]),angular.module("talon.common",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.common").controller("SignaturePadController",["$scope",function(e){e.closeDialog=function(){e.modal.hide(),e.isOpen=!1,window.screen&&window.screen.lockOrientation&&screen.lockOrientation("portrait")},e.accepted=function(n){e.modal.hide(),e.isOpen=!1,window.screen&&window.screen.lockOrientation&&screen.lockOrientation("portrait")}}]),angular.module("talon.common").factory("pouchDBUtils",["pouchDBDecorators",function(e){function n(e,n){n.constructor!==Array&&(n=[n]),e.createIndex({index:{fields:n}})}function t(n){n.find=e.qify(n.find),n.upsert=e.qify(n.upsert),n.putIfNotExists=e.qify(n.putIfNotExists),n.createIndex=e.qify(n.createIndex)}return{updatePouchDB:t,index:n}}]).service("httpUtils",["$q","$http","talonRoot","$cordovaNetwork",function(e,n,t,o){function r(){var r=e.defer(),a=!0;if(a=o.isOnline(),!a)return r.reject(),r.promise;var i=forge.util.bytesToHex(forge.random.getBytes(16));return n.get(t+"api/App/MobileClient/IsAlive?echo="+i,{timeout:2e3,cache:!1}).then(function(e){200!==e.status||i!=e.data?r.reject():r.resolve()},function(){r.reject()})["catch"](function(){r.reject()}),r.promise}return{checkConnectivity:r}}]).service("encryption",["$localStorage",function(e){function n(e,n,t){var o=forge.cipher.createCipher("AES-CBC",forge.util.createBuffer(forge.util.decode64(t),"raw"));o.start({iv:forge.util.createBuffer(n,"utf8")}),o.update(forge.util.createBuffer(forge.util.createBuffer(e,"utf8"))),o.finish();var r=o.output;return forge.util.encode64(r.bytes())}function t(e,n,t){var o=forge.cipher.createDecipher("AES-CBC",forge.util.createBuffer(forge.util.decode64(t),"raw"));return o.start({iv:forge.util.createBuffer(n,"utf8")}),o.update(forge.util.createBuffer(e,"raw")),o.finish(),0==o.output.toHex().indexOf("31393333")?o.output.toString():null}function o(n){var t=e.keyset.Vendor,o=forge.pki.privateKeyFromPem(t),r=n.split("|"),a=o.decrypt(forge.util.decode64(r[1]),"RSA-OAEP"),i=o.decrypt(forge.util.decode64(r[2]),"RSA-OAEP"),c=forge.cipher.createDecipher("AES-CBC",forge.util.createBuffer(a,"raw"));return c.start({iv:forge.util.createBuffer(i,"raw")}),c.update(forge.util.createBuffer(forge.util.decode64(r[0]),"raw")),c.finish()?c.output.toString():null}function r(n){var t=forge.random.getBytesSync(16),o=forge.random.getBytesSync(16),r=forge.util.createBuffer(n,"utf8"),a=e.keyset.Server,i=forge.pki.publicKeyFromPem(a),c=forge.cipher.createCipher("AES-CBC",t);c.start({iv:o}),c.update(forge.util.createBuffer(r)),c.finish();var u=forge.util.encode64(forge.util.hexToBytes(c.output.toHex())),l=[u,forge.util.encode64(i.encrypt(t,"RSA-OAEP")),forge.util.encode64(i.encrypt(o,"RSA-OAEP"))];return l.join("|")}return{encrypt:n,decrypt:t,encryptRsaData:r,decryptRsaData:o}}]),angular.module("talon.common").service("baseDB",["$q","$localStorage",function(e,n){function t(t){var o="DB_"+t;this.find=function(t){var r=e.defer(),a=n[o]||[];return t&&(a=a.filter(t)),r.resolve(a),r.promise},this.replace=function(t){n[o]=t||[];var r=e.defer();return r.resolve(t),r.promise},this.upsert=function(t,r){var a=e.defer(),i=n[o]||[];return i=i.filter(function(e){return e&&e._id&&e._id!=t}),i.push(r),n[o]=i,a.resolve(r),a.promise},this.all=function(){return n[o]}}return t}]).service("keyDB",["pouchDB","pouchDBUtils","baseDB",function(e,n,t){var o=new t("keyDB");return o}]).service("cardLoadDB",["pouchDB","pouchDBUtils","baseDB",function(e,n,t){var o=new t("cardLoadDB");return o}]).service("qrCodeDB",["pouchDB","pouchDBUtils","baseDB",function(e,n,t){var o=new t("qrCodeDB");return o}]).service("cardLoadHistoryDB",["pouchDB","pouchDBUtils","baseDB",function(e,n,t){var o=new t("cardLoadHistoryDB");return o}]).service("transactionHistoryDB",["pouchDB","pouchDBUtils","baseDB",function(e,n,t){var o=new t("transactionHistoryDB");return o}]),angular.module("talon.nfc",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.nfc").service("$nfcTools",["$timeout","$q","$cordovaDevice","$rootScope","$localStorage",function(e,n,t,o,r){function a(t,o,r){var a=n.defer(),i=function(n){r?e(function(){a.resolve(n)}):a.resolve(n)},c=function(n){r?e(function(){a.reject(n)}):a.reject(n)};return o.push(i),o.push(c),t.apply(window.nfcTools,o),a.promise}function i(){function e(){var e=n.defer(),t=o.$on("nfc:foundTag",function(n,o){t();var r=(o.ndefMessage||[]).map(function(e){return e.id=nfc.bytesToString(e.id),e.type=nfc.bytesToString(e.type),e.payload=nfc.bytesToString(e.payload),e});e.resolve(r.length?{id:r[0].id||forge.util.bytesToHex(forge.random.getBytes(16)),data:r[0].payload}:{id:forge.util.bytesToHex(forge.random.getBytes(16)),data:"",atr:null})});return e.promise}function r(){return l.acr35ReadIdFromTag().then(function(e){return l.acr35ReadDataFromTag().then(function(n){return e=e.constructor===Array?e[0]:e,{id:e,data:n[0],atr:n[1]}})})}var a=n.defer(),i=t.getPlatform();return"ios"==i.toLowerCase()?r():"android"==i.toLowerCase()?(window.nfc?window.nfc.enabled(function(){a.resolve(e())},function(){a.resolve(r())}):a.resolve(r()),a.promise):i.toLowerCase().indexOf("win")>-1||i.toLowerCase().indexOf("wp")>-1?a.promise:void 0}function c(){function e(){return i().then(function(e){return e.id})}function o(){return l.acr35ReadIdFromTag().then(function(e){return e=e.constructor===Array?e[0]:e})}var r=n.defer(),a=t.getPlatform();return"ios"==a.toLowerCase()?o():"android"==a.toLowerCase()?(window.nfc?window.nfc.enabled(function(){r.resolve(e())},function(){r.resolve(o())}):r.resolve(o()),r.promise):a.toLowerCase().indexOf("win")>-1||a.toLowerCase().indexOf("wp")>-1?(r.resolve(null),r.promise):void 0}function u(r,a){function i(t,r){var a=n.defer(),i=o.$on("nfc:foundTag",function(n,o){i();var c=[window.ndef.record(window.ndef.TNF_EXTERNAL_TYPE,util.stringToBytes("application/talon"),util.stringToBytes(r),util.stringToBytes(t))];nfc.write(c,function(){e(function(){a.resolve()})})});return a.promise}function c(e,n){return l.acr35WriteDataIntoTag(e)}var u=n.defer(),d=t.getPlatform();return"ios"==d.toLowerCase()?c(r):"android"==d.toLowerCase()?(window.nfc?window.nfc.enabled(function(){u.resolve(i(r,a))},function(){u.resolve(c(r,a))}):u.resolve(c(r,a)),u.promise):d.toLowerCase().indexOf("win")>-1||d.toLowerCase().indexOf("wp")>-1?u.promise:void 0}var l={readIdAndData:i,writeData:u,readId:c,acr35WriteDataIntoTag:function(e){return a(window.nfcTools.acr35WriteDataIntoTag,[e],!0)},acr35ReadDataFromTag:function(){return a(window.nfcTools.acr35ReadDataFromTag,[],!0)},acr35ReadIdFromTag:function(){return a(window.nfcTools.acr35ReadIdFromTag,[],!0)},acr35GetDeviceStatus:function(){return a(window.nfcTools.acr35GetDeviceStatus,[],!0)},acr35GetDeviceId:function(){return a(window.nfcTools.acr35GetDeviceId,[],!0)}};return l}]),angular.module("talon.settings",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.settings").controller("SyncController",["$scope","$localStorage","$settings",function(e,n,t){e.setupVendor=function(){t.sync().then(function(){e.$broadcast("scroll.refreshComplete")})}}]).controller("SettingsController",["$scope","$localStorage","$rootScope","$nfcTools",function(e,n,t,o){function r(e){n.country=e,t.country=e}function a(){delete n.authorizationData,e.showLoginModal()}e.country=t.country,e.logout=a,e.updateCountry=r,e.useNDEF=function(){n.useNDEF=!0}}]),angular.module("talon.settings").service("$settings",["$timeout","$q","$cordovaFile","httpUtils","$localStorage","$http","$ionicPlatform","talonRoot","$rootScope","$cordovaNetwork","$cordovaDevice","$cordovaFileTransfer","keyDB","cardLoadDB","qrCodeDB","cardLoadHistoryDB","transactionHistoryDB","encryption","$injector",function(e,n,t,o,r,a,i,c,u,l,d,s,f,p,h,v,g,m,y){function w(){var e=cordova.file.applicationDirectory,o=function(e){};return n.all([t.readAsDataURL(e+"www/","index.html").then(function(e){var n=forge.md.md5.create();return n.update(e),n.digest().toHex()})["catch"](function(e){return o(e),""}),t.readAsDataURL(e+"www/js/","app.js").then(function(e){var n=forge.md.md5.create();return n.update(e),n.digest().toHex()})["catch"](function(e){return o(e),""}),t.readAsDataURL(e+"www/js/","templates.js").then(function(e){var n=forge.md.md5.create();return n.update(e),n.digest().toHex()})["catch"](function(e){return o(e),""})]).then(function(e){var n=forge.md.md5.create();return n.update(e[0]),n.update(e[1]),n.update(e[2]),n.digest().toHex()})}function C(){var e=function(){return u.lastSynced=moment().locale("en-US").format("LLL"),!0},t=n.defer();return o.checkConnectivity().then(function(){n.all([a.get(c+"api/App/MobileClient/DownloadKeyset"),D(),T(),B(),b()]).then(function(n){var o=n[0];r.keyset=o.data,e(),t.resolve()})["catch"](t.resolve.bind(t))})["catch"](function(){k().then(I).then(e).then(t.resolve.bind(t))}),t.promise}function b(){var e=v.all(),t=g.all();return n.all([a.post(c+"api/App/MobileClient/UploadCardLoads",e),a.post(c+"api/App/MobileClient/UploadTransactions",t)]).then(function(){v.replace(),g.replace()})}function D(){return a.get(c+"api/App/MobileClient/DownloadBeneficiaryKeys").then(function(e){return $(e.data)})}function $(e){return f.replace(e)}function B(){return a.get(c+"api/App/MobileClient/GenerateCardLoads").then(function(e){return S(e.data)})}function S(e){return p.replace(e)}function T(){return a.get(c+"api/App/MobileClient/GenerateQRCodes").then(function(e){return U(e.data)})}function U(e){return h.replace(e)}function I(o){function a(t,o){var r=n.defer(),a=d.getUUID(),i=encodeURI("http://10.10.10.254/data/UsbDisk1/Volume1/Talon/"+a+".zip");return cordovaHTTP.uploadFile(i,{},{Authorization:"Basic "+forge.util.encode64("admin:"),"Content-Type":null},t.toURL(),"file",function(n){e(function(){r.resolve()})},function(n){e(function(){r.reject()})}),r.promise}var i=function(e){throw e},c=new JSZip;c.file("cardLoadHistoryDB.b64",m.encryptRsaData(JSON.stringify(v.all()))),c.file("transactionHistoryDB.b64",m.encryptRsaData(JSON.stringify(g.all()))),c.file("vendorProfile.b64",m.encryptRsaData(JSON.stringify(r.currentUser)));var u=c.generate({type:"blob"}),l=cordova.file.tempDirectory||cordova.file.cacheDirectory;return t.createFile(l,"upload.zip",!0).then(function(e){return t.writeFile(l,"upload.zip",u,!0).then(function(){return a(e,u)["catch"](i)})["catch"](i)})["catch"](i)}function k(){function e(e){var n=encodeURI("http://10.10.10.254/data/UsbDisk1/Volume1/Talon/"+r.country.IsoAlpha3+".zip");return s.download(n,e.toURL())["catch"](a)}var o=cordova.file.tempDirectory||cordova.file.cacheDirectory,a=function(e){throw e};return t.createFile(o,"load.zip",!0).then(function(r){return e(r).then(function(e){return t.readAsArrayBuffer(o,"load.zip").then(function(e){var r=new JSZip(e),i=m.decryptRsaData(r.file("QRCodes.b64").asText()),c=m.decryptRsaData(r.file("CardLoads.b64").asText()),u=m.decryptRsaData(r.file("BeneficiaryKeys.b64").asText());return n.all([S(JSON.parse(c)),U(JSON.parse(i)),$(JSON.parse(u))]).then(function(){return t.removeFile(o,"load.zip").then(function(){})})["catch"](a)})["catch"](a)})["catch"](a)})["catch"](a)}return{hashApplication:w,sync:C}}]),angular.module("talon.transaction",["ngStorage","ngCordova","talon.constants","talon.nfc","talon.common","talon.settings","pouchdb"]),angular.module("talon.transaction").controller("PinController",["$scope","$location","$timeout",function(e,n,t){e.cancel=function(){e.passcode="",e.modal.hide(),e.deferred.reject()},e.add=function(n){e.passcode.length<4&&(e.passcode=e.passcode+n,4==e.passcode.length&&t(function(){e.deferred.resolve(e.passcode),e.modal.hide(),t(function(){e.passcode=""},100)},0))},e["delete"]=function(){e.passcode.length>0&&(e.passcode=e.passcode.substring(0,e.passcode.length-1))}}]).controller("POSController",["$scope","$ionicModal","$q","transactionData","beneficiaryData","$cordovaSpinnerDialog","$timeout","$filter",function(e,n,t,o,r,a,i,c){function u(n){alert("The transaction in the amount of "+c("currency")(n,e.country.CurrencyIsoCode+" ")+" has been completed.")}e.decimalChar=".",e.value="",e.clear=function(){e.value=""},e["delete"]=function(){var n=e.value.toString(10);e.value=n.substring(0,n.length-1)},e.addDigit=function(n){(n!=e.decimalChar||-1==e.value.indexOf(e.decimalChar))&&(e.value=e.value+n)},e.qrDialogOpen=!1,e.processQR=function(){var n=function(n){e.qrDialogOpen=!1,alert(n.message)};if(!e.qrDialogOpen){e.qrDialogOpen=!0;window.cordova&&window.cordova.plugins&&cordova.plugins.barcodeScanner&&cordova.plugins.barcodeScanner.scan(function(t){i(function(){if(e.qrDialogOpen=!1,!t.cancelled){var a=t.text;e.showPinModal().then(function(t){r.validateQRCode(a,t).then(function(r){return moment.unix(r.validAfter)>moment()?void alert("Voucher can't be used before "+moment.unix(r.validAfter).locale("en-Us").format("L")+"."):void e.showQRConfirmationModal(r,t).then(function(e){var t=e[0].beneficiary,r=e.map(function(e){return e.voucherCode});o.debitQRCodes(r,t).then(function(){var n=e.map(function(e){return e.value}).reduce(function(e,n){return e+n},0);u(n)})["catch"](n)})["catch"](n)})["catch"](n)})["catch"](n)}})},n)}},e.process=function(){var n=function(n){a.hide(),e.clear()},t=function(e){alert("Invalid PIN."),a.hide()},i=function(e){alert("Not enough credit"),a.hide()};return e.value?(a.show("Read Card","Please hold NFC card close to reader",!0),void r.readRawCardData().then(function(r){a.hide(),e.showPinModal().then(function(n){var c=parseFloat(e.value,10);o.loadCurrentData(n,r).then(function(t){e.clear(),e.showConfirmationModal({card:t,value:c},n).then(function(){a.show("Read Card","Please hold NFC card close to reader",!0),o.debitCard(t,c,n).then(function(){a.hide(),u(c)})["catch"](i)})})["catch"](t)})["catch"](n)})["catch"](n)):void alert("There is no value to be charged.")}}]).controller("ConfirmationController",["$scope","$location","$timeout",function(e,n,t){e.$watch("data",function(){e.data&&(e.total=e.data.card.current[0]+e.data.card.pending[0]-e.data.value)}),e.cancel=function(){delete e.data,delete e.pin,e.modal.hide(),e.deferred.reject()},e.pay=function(){delete e.data,delete e.pin,e.modal.hide(),e.deferred.resolve()}}]).controller("QRConfirmationController",["$scope","$location","beneficiaryData","$timeout",function(e,n,t,o){e.addVoucher=function(){var n=function(e){alert(e.message),$cordovaSpinnerDialog.hide()},r=e.pin;window.cordova&&window.cordova.plugins&&cordova.plugins.barcodeScanner&&cordova.plugins.barcodeScanner.scan(function(a){o(function(){var o=a.text;a.cancelled||t.validateQRCode(o,r).then(function(n){
var t=e.vouchers.map(function(e){return e.voucherCode}),o=e.vouchers[0].beneficiary;return moment.unix(n.validAfter)>moment()?void alert("Voucher can't be used before "+moment.unix(n.validAfter).locale("en-Us").format("L")+"."):n.beneficiary.BeneficiaryId!=o.BeneficiaryId?void alert("Voucher belongs to a different beneficiary."):t.indexOf(n.voucherCode)>-1?void alert("Voucher already added"):void e.vouchers.push(n)})["catch"](n)})},n)},e.cancel=function(){delete e.vouchers,delete e.pin,e.modal.hide(),e.deferred.reject()},e.pay=function(){e.deferred.resolve(e.vouchers),delete e.vouchers,delete e.pin,e.modal.hide()}}]),angular.module("talon.transaction").service("transactionData",["$http","$localStorage","$q","talonRoot","$timeout","$cordovaFile","$cordovaFileTransfer","$settings","transactionHistoryDB","$rootScope","cardLoadHistoryDB","beneficiaryData","httpUtils",function e(n,t,o,r,a,i,c,u,l,d,s,e,f){function p(n,t){var o=function(e){throw e};return e.readCardData(n,t).then(function(t){return e.fetchPendingLoads(n,t).then(function(e){var n=t.beneficiary,o=t.payload,r=e.pending;return{beneficiary:n,current:o,pending:r}})["catch"](o)})["catch"](o)}function h(n,r,i){var c=o.defer(),l=function(e){alert(e.message),c.reject([-2,e])},d=n.current,f=n.pending,p=n.beneficiary,h=d[0]+f[0]-r,v=f[0]>0?f[1].unix():d[1];return h=Math.round(1e3*h)/1e3,u.hashApplication().then(function(n){var o="1933|"+h+"|"+v.toString(16);if(2==t.authorizationData.tokenType)return alert("You are logged in as an administrator. The POS mode is available for demo use only. The transaction will not be completed."),void c.resolve();if(v>d[1]){var u={_id:p.BeneficiaryId+"-"+moment().unix(),beneficiaryId:p.BeneficiaryId,amount:f[0],date:moment().unix(),distributionDate:f[1].unix()};s.upsert(u._id,u)}a(function(){e.updateCardData(o,p.CardKey,i,p.CardId).then(function(e){g({type:2,beneficiaryId:p.BeneficiaryId,amountCredited:r,amountRemaining:h,date:moment().unix(),checksum:n}).then(function(){c.resolve()})["catch"](l)})["catch"](l)},500)})["catch"](l),c.promise}function v(e,n){var r=o.defer(),a=function(e){r.resolve()};return u.hashApplication().then(function(i){if(2==t.authorizationData.tokenType)return alert("You are logged in as an administrator. The POS mode is available for demo use only. The transaction will not be completed."),void r.resolve();var c=e.map(function(e){return g({type:3,beneficiaryId:n.BeneficiaryId,voucherCode:e,date:moment().unix(),checksum:i})});o.when(c).then(function(e){r.resolve()})["catch"](a)})["catch"](a),r.promise}function g(e){var t=o.defer();return e.transactionCode=forge.util.bytesToHex(forge.random.getBytes(8)),e._id=e.beneficiaryId+"-"+e.date+"-"+e.transactionCode,e.location=d.currentLocation,e.quarantine=!1,f.checkConnectivity().then(function(){var o=2==e.type?"ProcessNFCTransaction":"ProcessQRTransaction";n.post(r+"api/App/MobileClient/"+o,e).then(function(n){return n.data&&(n=n.data),n.Success?(e.confirmationCode=n.ConfirmationCode,l.upsert(e._id,e),void t.resolve()):void t.reject(n.message)})})["catch"](function(){e.quarantine=!0,l.upsert(e._id,e),t.resolve()}),t.promise}return{processTransaction:g,loadCurrentData:p,debitCard:h,debitQRCodes:v}}]);