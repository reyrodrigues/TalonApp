angular.module("talon",["ionic","talon.constants","talon.controllers","talon.templates","talon.auth","talon.beneficiary","talon.common","talon.nfc","talon.transaction"]).run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),window.StatusBar&&StatusBar.styleLightContent()})}]).config(["$stateProvider","$urlRouterProvider","$httpProvider",function(e,t,n){n.interceptors.push("authInterceptor"),e.state("app",{url:"/app","abstract":!0,templateUrl:"templates/menu.html",controller:"AppController"}).state("app.pos",{url:"/pos",views:{menuContent:{templateUrl:"templates/pos.html"}}}).state("app.beneficiary",{url:"/beneficiary",views:{menuContent:{templateUrl:"templates/beneficiary.html"}}}).state("app.list-beneficiaries",{url:"/list-beneficiaries",views:{menuContent:{templateUrl:"templates/list-beneficiaries.html"}}}).state("app.view-beneficiary",{url:"/view-beneficiary/:id",views:{menuContent:{templateUrl:"templates/view-beneficiary.html"}}}).state("app.receipts",{url:"/receipts",views:{menuContent:{templateUrl:"templates/blank.html"}}}).state("app.invoices",{url:"/invoices",views:{menuContent:{templateUrl:"templates/blank.html"}}}).state("app.sync",{url:"/sync",views:{menuContent:{templateUrl:"templates/sync.html"}}}).state("app.settings",{url:"/settings",views:{menuContent:{templateUrl:"templates/settings.html"}}}),t.otherwise("/app/pos")}]),angular.module("talon.constants",[]).constant("talonRoot","http://74ced177.ngrok.io/"),angular.module("talon.controllers",["ngStorage","talon.templates","talon.auth","talon.beneficiary","talon.common","talon.nfc","talon.transaction","ngCordova"]).controller("AppController",["$scope","beneficiaryData","$timeout","$rootScope","$cordovaGeolocation","$ionicPlatform","$nfcTools","$localStorage","$ionicModal","$q","$cordovaSpinnerDialog","adminAuthentication","$nfcTools",function(e,t,n,o,r,a,i,c,u,l,s,d,i){function f(){i.acr35GetDeviceStatus().then(function(e){o.device.batteryLevel=e[0],o.device.sleepTimeout=e[1],i.acr35GetDeviceId().then(function(e){o.device.deviceId=e})})}function p(){return e.pin.deferred=l.defer(),e.pin.passcode="",e.login.modal&&e.pin.modal.show(),e.pin.deferred.promise}function h(){return e.login.deferred=l.defer(),delete c.authorizationData,delete o.authorizationData,delete c.currentUser,delete o.currentUser,delete c.organization,delete o.organization,delete c.country,delete o.country,e.login.modal&&e.login.modal.show(),e.login.deferred.promise}e.pin=e.$new(),e.login=e.$new(),o.device={},u.fromTemplateUrl("templates/login.html",{scope:e.login,focusFirstInput:!0,backdropClickToClose:!1,hardwareBackButtonClose:!1}).then(function(t){e.login.modal=t}),u.fromTemplateUrl("templates/pin-code.html",{scope:e.pin}).then(function(t){e.pin.modal=t}),a.ready(f),o.$on("onResumeCordova",f),c.authorizationData?(o.authorizationData=c.authorizationData,2!=c.authorizationData.tokenType||o.currentUser||d.loadUserData()):e.login.$watch("modal",function(){e.login.modal&&h().then(function(){})}),e.readIdIso=function(){window.nfcTools&&window.nfcTools.isoDepReadIdFromTag(function(){console.log("success")},function(){console.log("Error")})},e.setupVendor=function(){t.loadKeys().then(function(e){t.loadCardLoads().then(function(e){})})},e.provisionCard=function(){var e=prompt("beneficiaryId");t.provisionBeneficiary(e).then(function(){})},e.loadCard=function(){p().then(function(e){t.fetchBeneficiary().then(function(o){t.fetchCardLoad(o.BeneficiaryId,o.CardKey,e).then(function(r){if(r){var a="1933|"+r[0]+"|"+r[1].toString(16);n(function(){t.updateCard(a,o.CardKey,e).then(function(e){})},1e3)}})})})},e.readCard=function(){var n=function(e){s.hide()};p().then(function(o){s.show("Read Card","Please hold NFC card close to reader",!0),t.fetchBeneficiary().then(function(r){t.readCard(r.CardKey,o).then(function(t){e.cardInfo=t,s.hide()})["catch"](n)})["catch"](n)})["catch"](n)},e.showPinModal=p,e.showLoginModal=h,a.ready(function(){var e={timeout:1e4,enableHighAccuracy:!1};r.getCurrentPosition(e).then(function(e){o.currentLocation=e.coords},function(e){})})}]).controller("SettingsController",["$scope","$localStorage","$rootScope","$nfcTools",function(e,t,n,o){function r(e){t.country=e,console.log(e)}function a(){delete t.authorizationData,e.showLoginModal()}e.country=n.country,e.logout=a,e.updateCountry=r,e.checkDeviceStatus=function(){o.acr35GetDeviceStatus().then(function(){o.acr35GetDeviceId().then(function(){})})}}]),angular.module("talon.auth",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.auth").controller("LoginController",["$scope","$rootScope","$localStorage","vendorAuthentication","adminAuthentication",function(e,t,n,o,r){e.loginData={},e.wrongPassword=!1,e.loginAdmin=function(){r.login(e.loginData.username,e.loginData.password).then(function(){t.authorizationData=n.authorizationData,r.loadUserData().then(function(){e.deferred.resolve(),e.modal.hide(),e.wrongPassword=!1,e.loginData={}})})["catch"](function(){e.wrongPassword=!0})},e.loginVendor=function(){o.login(e.loginData.username,e.loginData.password).then(function(){e.deferred.resolve(),e.modal.hide(),e.wrongPassword=!1,e.loginData={},t.authorizationData=n.authorizationData})["catch"](function(){e.wrongPassword=!0})}}]),angular.module("talon.auth").factory("authInterceptor",["$q","$injector","$location","$localStorage",function(e,t,n,o,r){var a={},i=function(e){e.headers=e.headers||{};var t=o.authorizationData;if(t&&(e.headers.Authorization=(1==o.authorizationData.tokenType?"Token ":"Bearer ")+t.token),o.currentUser){if(o.authorizationData&&2==o.authorizationData.tokenType&&o.currentUser.Organization){var n=o.currentUser.Organization.Id;e.headers["X-Tenant-Organization"]=n}if(o.authorizationData&&1==o.authorizationData.tokenType){o.currentUser.Id}if(o.country){var r=o.country.Id;e.headers["X-Tenant-Country"]=r}}return e},c=function(t){return 401===t.status,e.reject(t)};return a.request=i,a.responseError=c,a}]),angular.module("talon.auth").service("adminAuthentication",["$http","$localStorage","$q","$rootScope","talonRoot","$cordovaDevice",function(e,t,n,o,r,a){function i(o,r){var a="grant_type=password&username="+o+"&password="+r,i=n.defer();return e.post(l+"token",a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(e){t.authorizationData={token:e.access_token,userName:o,uuid:s.UUID||s.uuid,tokenType:2},i.resolve(!0)}).error(function(e,t){c(),i.reject(!1)}),i.promise}function c(){}function u(){var r=n.defer();if(t.currentUser){o.currentUser=t.currentUser,o.organization=o.currentUser.Organization;var a=o.currentUser.Countries.map(function(e){return e.Country});t.country||(t.country=a[0]),o.country=t.country,o.availableCountries=o.currentUser.Countries.length>1?a:!1,r.resolve()}else e.get(l+"api/Account/Me").then(function(e){o.currentUser=e.data,t.currentUser=e.data,o.organization=o.currentUser.Organization,t.organization=o.currentUser.Organization;var n=o.currentUser.Countries.map(function(e){return e.Country});t.country||(t.country=n[0]),o.country=t.country,o.availableCountries=o.currentUser.Countries.length>1?n:!1,r.resolve()})["catch"](function(e){console.log(e),r.reject(e)});return r.promise}var l=r,s={};return window.device?s=a.getDevice():s.uuid="00:00:00:00",{login:i,logOut:c,loadUserData:u}}]).service("vendorAuthentication",["$http","$q","talonRoot","$cordovaDevice","$localStorage","$rootScope",function(e,t,n,o,r,a){function i(a,i){var u={};window.device?u=o.getDevice():u.uuid="00:00:00:00";var l={UserName:a,Password:i,Device:u},s=t.defer();return e.post(n+"api/App/VendorProfile/Login",l).then(function(e){200==e.status?(r.authorizationData={userName:l.UserName,token:e.data.token,uuid:u.UUID||u.uuid,tokenType:1},c(e.data.id).then(function(){s.resolve(r.authorizationData)})):s.reject(e.data)})["catch"](function(e,t){s.reject(e)}),s.promise}function c(o){var i=t.defer();return r.currentUser?(a.currentUser=r.currentUser,r.country||(r.country=a.currentUser.Country),a.country=r.country,i.resolve()):e.get(n+"api/App/VendorProfile/LoadProfile").then(function(e){a.currentUser=e.data,r.currentUser=e.data,r.country||(r.country=a.currentUser.Country),a.country=r.country,i.resolve()})["catch"](function(e){console.log(e),i.reject(e)}),i.promise}var u={login:i};return u}]),angular.module("talon.beneficiary",["ngStorage","ngCordova","talon.constants","pouchdb","talon.nfc","talon.common"]),angular.module("talon.beneficiary").controller("BeneficiaryController",["$scope","$localStorage","$ionicModal","$cordovaSpinnerDialog","beneficiaryData",function(e,t,n,o,r){function a(){var t=function(e){console.log(e),o.hide()};e.showPinModal().then(function(e){o.show("Reload Card","Please hold NFC card close to reader",!0),r.reloadCard(e).then(function(){o.hide()})["catch"](t)})["catch"](t)}function i(){var t=function(e){console.log(e),o.hide()};e.showPinModal().then(function(n){o.show("Read Card","Please hold NFC card close to reader",!0),r.readCardData(n).then(function(t){e.cardInfo=t,o.hide()})["catch"](t)})["catch"](t)}e.reloadCard=a,e.readCard=i}]).controller("ListBeneficiaryController",["$scope","$localStorage","$q","$timeout","$http","beneficiaryData",function(e,t,n,o,r,a){function i(t){return c&&o.cancel(c),c=o(function(){a.listBeneficiariesByName(t).then(function(t){e.beneficiaries=t}),c=null},500)}e.beneficiaries=[],e.beneficiariesByName=i;var c=null}]).controller("ViewBeneficiaryController",["$scope","$localStorage","$q","$timeout","$http","$state","talonRoot","beneficiaryData",function(e,t,n,o,r,a,i,c){e.provisionCard=function(){var t=e.beneficiary.Id;c.provisionBeneficiary(t).then(function(){})},c.fetchBeneficiaryById(a.params.id).then(function(t){e.beneficiary=t})}]),angular.module("talon.beneficiary").directive("ionSearch",function(){return{restrict:"E",replace:!0,scope:{getData:"&source",model:"=?",search:"=?filter"},link:function(e,t,n){n.minLength=n.minLength||0,e.placeholder=n.placeholder||"",e.search={value:""},n["class"]&&t.addClass(n["class"]),n.source&&e.$watch("search.value",function(t,o){t.length>n.minLength?e.getData({str:t}).then(function(t){e.model=t}):e.model=[]}),e.clearSearch=function(){e.search.value=""}},template:'<div class="item-input-wrapper"><i class="icon ion-android-search"></i><input type="search" placeholder="{{placeholder}}" ng-model="search.value"><i ng-if="search.value.length > 0" ng-click="clearSearch()" class="icon ion-close"></i></div>'}}),angular.module("talon.beneficiary").service("beneficiaryData",["$http","$localStorage","keyDB","cardLoadDB","$q","talonRoot","$nfcTools","$ionicPlatform","$timeout","$cordovaFile","$cordovaFileTransfer","httpUtils","encryption","$state",function(e,t,n,o,r,a,i,c,u,l,s,d,f,p){function h(t,o){var u=r.defer();return c.ready(function(){i.acr35ReadIdFromTag().then(function(o){var r=o[0];e.post(a+"api/App/MobileClient/ProvisionBeneficiary",{beneficiaryId:t,cardId:r}).then(function(t){var o=t.data;n.upsert(o._id,function(e){return{BeneficiaryId:o.BeneficiaryId,CardId:o.CardId,CardKey:o.CardKey}}),e.get(a+"api/App/MobileClient/GenerateInitialLoad?beneficiaryId="+o.BeneficiaryId).then(function(e){var t=e.data;t=forge.util.createBuffer(forge.util.decode64(t),"raw").toHex(),i.acr35WriteDataIntoTag(t).then(function(e){u.resolve()})})})})["catch"](function(){u.reject()})}),u.promise}function g(e){return i.readIdAndData().then(function(t){return C(t.id).then(function(n){return y(t.data,n.CardKey,e).then(function(e){return{beneficiary:n,payload:e}})})})}function m(e){var t=r.defer(),n=function(e){console.log(e),t.reject(e)};return g(e).then(function(r){var a=r.payload,i=r.beneficiary,c=moment.unix(a[1]),l=a[0];o.find({selector:{CardId:i.CardId}}).then(function(o){var r=o.docs[0].Load,a=r.map(function(t){var n=forge.util.decode64(t),o=f.decrypt(n,e,i.CardKey);if(!o)throw new Error;var r=o.split("|");return[parseFloat(r[1],10),moment.unix(parseInt(r[2],16))]}),s=a.filter(function(e){return e[1]>c}).reduce(function(e,t){return[e[0]+t[0],e[1]>t[1]?e[1]:t[1]]},[0,0]);if(0==s[0]&&0==s[1])console.log("No loads for this card"),t.resolve();else{var d="1933|"+(s[0]+l)+"|"+s[1].unix().toString(16);u(function(){v(d,i.CardKey,e).then(function(e){t.resolve()})["catch"](n)},500)}})["catch"](n)})["catch"](n),t.promise}function v(e,t,n){var o=f.encrypt(e,n,t),a=forge.util.createBuffer(forge.util.decode64(o),"raw").toHex(),c=r.defer();return i.writeData(a).then(function(e){c.resolve(e)}),c.promise}function y(e,t,n){var o=r.defer(),a=e.indexOf("0000");a%2==1&&(a+=1);var i=e.substring(0,a),c=forge.util.hexToBytes(i),u=f.decrypt(c,n,t);if(!u)return o.reject(),o.promise;var l=u.split("|"),s=[parseFloat(l[1],10),parseInt(l[2],16)];return o.resolve(s),o.promise}function C(e){var t=r.defer();return n.find({selector:{CardId:e}}).then(function(e){e.docs.length&&t.resolve(e.docs[0]),t.reject()}),t.promise}function D(t){var n="$filter=startswith(tolower(FirstName), '"+encodeURIComponent(t.toLowerCase())+"') or startswith(tolower(LastName), '"+encodeURIComponent(t.toLowerCase())+"')";return e.get(a+"Breeze/EVM/Beneficiaries?"+n).then(function(e){return e.data})}function w(t){return e.get(a+"Breeze/EVM/Beneficiaries?$expand=Location&$filter=Id eq "+p.params.id).then(function(e){return e.data[0]})}return{reloadCard:m,readCardData:g,updateCardData:v,provisionBeneficiary:h,listBeneficiariesByName:D,fetchBeneficiaryById:w}}]),angular.module("talon.common",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.common").service("pouchDBUtils",["pouchDBDecorators",function(e){function t(e,t){t.constructor!==Array&&(t=[t]),e.createIndex({index:{fields:t}})}function n(t){t.find=e.qify(t.find),t.upsert=e.qify(t.upsert),t.putIfNotExists=e.qify(t.putIfNotExists),t.createIndex=e.qify(t.createIndex)}return{updatePouchDB:n,index:t}}]).service("httpUtils",["$q","$http","talonRoot",function(e,t,n){function o(){var o=e.defer();return t.get(n+"api/App/MobileClient/IsAlive").then(function(e){200!==e.status?o.reject():o.resolve()})["catch"](o.reject.bind(o)),o.promise}return{checkConnectivity:o}}]).service("encryption",["$localStorage",function(e){function t(e,t,n){var o=forge.cipher.createCipher("AES-CBC",forge.util.createBuffer(forge.util.decode64(n),"raw"));o.start({iv:forge.util.createBuffer(t,"utf8")}),o.update(forge.util.createBuffer(forge.util.createBuffer(e,"utf8"))),o.finish();var r=o.output;return forge.util.encode64(r.bytes())}function n(e,t,n){var o=forge.cipher.createDecipher("AES-CBC",forge.util.createBuffer(forge.util.decode64(n),"raw"));return o.start({iv:forge.util.createBuffer(t,"utf8")}),o.update(forge.util.createBuffer(e,"raw")),o.finish(),0==o.output.toHex().indexOf("31393333")?o.output.toString():null}function o(t){var n=e.keyset.Vendor,o=forge.pki.privateKeyFromPem(n),r=t.split("|"),a=o.decrypt(forge.util.decode64(r[1]),"RSA-OAEP"),i=o.decrypt(forge.util.decode64(r[2]),"RSA-OAEP"),c=forge.cipher.createDecipher("AES-CBC",forge.util.createBuffer(a,"raw"));return c.start({iv:forge.util.createBuffer(i,"raw")}),c.update(forge.util.createBuffer(forge.util.decode64(r[0]),"raw")),c.finish()?c.output.toString():null}function r(t){var n=forge.random.getBytesSync(16),o=forge.random.getBytesSync(16),r=forge.util.createBuffer(t,"utf8"),a=e.keyset.Server,i=forge.pki.publicKeyFromPem(a),c=forge.cipher.createCipher("AES-CBC",n);c.start({iv:o}),c.update(forge.util.createBuffer(r)),c.finish();var u=forge.util.encode64(forge.util.hexToBytes(c.output.toHex())),l=[u,forge.util.encode64(i.encrypt(n,"RSA-OAEP")),forge.util.encode64(i.encrypt(o,"RSA-OAEP"))];return l.join("|")}return{encrypt:t,decrypt:n,encryptRsaData:r,decryptRsaData:o}}]),angular.module("talon.common").service("keyDB",["pouchDB","pouchDBUtils",function(e,t){var n=e("keyStore",{adapter:"websql"});return t.index(n,"CardId"),t.index(n,"BeneficiaryId"),t.updatePouchDB(n),n}]).service("cardLoadDB",["pouchDB","pouchDBUtils",function(e,t){var n=e("cardLoadStore",{adapter:"websql"});return t.index(n,"CardId"),t.updatePouchDB(n),n}]).service("cardLoadHistoryDB",["pouchDB","pouchDBUtils",function(e,t){var n=e("cardLoadHistoryStore",{adapter:"websql"});return t.updatePouchDB(n),n}]).service("transactionHistoryDB",["pouchDB","pouchDBUtils",function(e,t){var n=e("transactionHistoryStore",{adapter:"websql"});return t.index(n,"CardId"),t.index(n,"BeneficiaryId"),t.index(n,"TransactionCode"),t.updatePouchDB(n),n}]),angular.module("talon.nfc",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.nfc").service("$nfcTools",["$timeout","$q",function(e,t){function n(n,o,r){var a=t.defer(),i=function(t){console.log("success"),r?e(function(){a.resolve(t)}):a.resolve(t)},c=function(t){console.log("fail"),r?e(function(){a.reject(t)}):a.reject(t)};return o.push(i),o.push(c),n.apply(window.nfcTools,o),a.promise}function o(){return a.acr35ReadIdFromTag().then(function(e){return a.acr35ReadDataFromTag().then(function(t){return e=e.constructor===Array?e[0]:e,{id:e,data:t[0],atr:t[1]}})})}function r(e){return a.acr35WriteDataIntoTag(e)}var a={readIdAndData:o,writeData:r,acr35WriteDataIntoTag:function(e){return console.log("acr35WriteDataIntoTag"),n(window.nfcTools.acr35WriteDataIntoTag,[e],!0)},acr35ReadDataFromTag:function(){return console.log("acr35ReadDataFromTag"),n(window.nfcTools.acr35ReadDataFromTag,[],!0)},acr35ReadIdFromTag:function(){return console.log("acr35ReadIdFromTag"),n(window.nfcTools.acr35ReadIdFromTag,[],!0)},acr35GetDeviceStatus:function(){return console.log("acr35GetDeviceStatus"),n(window.nfcTools.acr35GetDeviceStatus,[],!0)},acr35GetDeviceId:function(){return console.log("acr35GetDeviceId"),n(window.nfcTools.acr35GetDeviceId,[],!0)}};return a}]),angular.module("talon.settings",["ngStorage","ngCordova","talon.constants","pouchdb"]),angular.module("talon.settings").controller("SyncController",["$scope","$localStorage","$settings",function(e,t,n){e.setupVendor=function(){n.sync()}}]),angular.module("talon.settings").service("$settings",["$timeout","$q","$cordovaFile","httpUtils","keyDB","cardLoadDB","$localStorage","$http","$ionicPlatform","talonRoot",function(e,t,n,o,r,a,i,c,u,l){function s(){var e=cordova.file.applicationDirectory,o=function(e){console.log(e)};return t.all({"index.html":n.readAsDataURL(e+"www/","index.html").then(function(e){var t=forge.md.md5.create();return t.update(e),t.digest().toHex()})["catch"](function(e){return o(e),""}),"app.js":n.readAsDataURL(e+"www/js/","app.js").then(function(e){var t=forge.md.md5.create();return t.update(e),t.digest().toHex()})["catch"](function(e){return o(e),""})})}function d(){var e=t.defer();o.checkConnectivity().then(function(){f().then(function(){h().then(function(){c.get(l+"api/App/MobileClient/DownloadKeyset").then(function(t){i.keyset=t.data,e.resolve()})["catch"](e.resolve.bind(e))})})})["catch"](function(){m().then(e.resolve.bind(e))}),e.promise}function f(){return console.log("Internet"),c.get(l+"api/App/MobileClient/DownloadBeneficiaryKeys").then(function(e){return p(e.data)})}function p(e){return t.all(e.map(function(e){return r.upsert(e._id,function(t){return{BeneficiaryId:e.BeneficiaryId,CardId:e.CardId,CardKey:e.CardKey}}).then(function(){return e})}))}function h(){return console.log("Internet"),c.get(l+"api/App/MobileClient/GenerateCardLoads").then(function(e){return g(e.data)})}function g(e){return t.all(e.map(function(e){return a.upsert(e._id,function(t){return{CardId:e.CardId,Load:e.Load}}).then(function(){return e})}))}function m(){var e=t.defer();return u.ready(function(){var t=encodeURI("http://10.10.10.254/data/UsbDisk1/Volume1/Talon/"+i.country.IsoAlpha3+".zip"),o=cordova.file.tempDirectory||cordova.file.cacheDirectory,r=function(t){console.log(t),e.reject()};n.createFile(o,"load.zip",!0).then(function(a){$cordovaFileTransfer.download(t,a.toURL()).then(function(t){n.readAsArrayBuffer(o,"load.zip").then(function(t){var a=new JSZip(t),i=decryptRsaData(a.file("CardLoads.b64").asText()),c=decryptRsaData(a.file("BeneficiaryKeys.b64").asText());g(JSON.parse(i)).then(function(){p(JSON.parse(c)).then(function(){n.removeFile(o,"load.zip").then(function(){console.log("Loaded from wifi storage"),e.resolve()})["catch"](r)})["catch"](r)})["catch"](r)})["catch"](r)})["catch"](r)})["catch"](r)}),e.promise}return{hashApplication:s,sync:d}}]),angular.module("talon.transaction",["ngStorage","ngCordova","talon.constants","talon.nfc","talon.common","talon.settings","pouchdb"]),angular.module("talon.transaction").controller("PinController",["$scope","$location","$timeout",function(e,t,n){e.cancel=function(){e.passcode="",e.modal.hide(),e.deferred.reject()},e.add=function(t){e.passcode.length<4&&(e.passcode=e.passcode+t,4==e.passcode.length&&n(function(){e.deferred.resolve(e.passcode),e.modal.hide(),n(function(){e.passcode=""},100)},0))},e["delete"]=function(){e.passcode.length>0&&(e.passcode=e.passcode.substring(0,e.passcode.length-1))}}]).controller("POSController",["$scope","$ionicModal","$q","transactionData","$cordovaSpinnerDialog","$timeout",function(e,t,n,o,r,a){e.decimalChar=".",e.value="",e.clear=function(){e.value=""},e["delete"]=function(){var t=e.value.toString(10);e.value=t.substring(0,t.length-1)},e.addDigit=function(t){(t!=e.decimalChar||-1==e.value.indexOf(e.decimalChar))&&(e.value=e.value+t)},e.process=function(){var t=function(t){console.log(t),r.hide(),e.clear()};e.showPinModal().then(function(n){r.show("Read Card","Please hold NFC card close to reader",!0),o.debitCard(parseFloat(e.value,10),n).then(function(){r.hide(),e.clear()})["catch"](t)})["catch"](t)}}]),angular.module("talon.transaction").service("transactionData",["$http","$localStorage","$q","talonRoot","$timeout","$cordovaFile","$cordovaFileTransfer","$settings","transactionHistoryDB","$rootScope","beneficiaryData","httpUtils",function e(t,n,o,r,a,i,c,u,l,s,e,d){function f(t,n){var r=o.defer(),i=function(e){r.reject([-2,e])};return e.readCardData(n).then(function(o){var i=o.payload,c=o.beneficiary,l=i[0]-t;l>=0&&t>0?(l=Math.round(1e3*l)/1e3,u.hashApplication().then(function(o){var u="1933|"+l+"|"+i[1].toString(16);a(function(){e.updateCardData(u,c.CardKey,n).then(function(e){p({beneficiary:c,amountCredited:t,amountRemaining:l,date:moment().unix(),checksum:o}).then(function(){r.resolve()})})},500)})):r.reject([-1,"Not enough credit."])})["catch"](i),r.promise}function p(e){var n=o.defer();return console.log("Writing transaction record in db"),e._id=e.beneficiary.BeneficiaryId+"-"+e.date,e.transactionCode=forge.util.bytesToHex(forge.random.getBytes(8)),e.location=s.currentLocation,l.put(e),console.log(e),d.checkConnectivity().then(function(){console.log("Process Transaction Online"),t.post(r+"api/App/MobileClient/ProcessNFCTransaction",e).then(function(){n.resolve()})})["catch"](function(){console.log("Process Transaction Offline"),n.resolve()}),n.promise}return{processTransaction:p,debitCard:f}}]);